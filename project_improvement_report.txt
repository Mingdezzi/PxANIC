[PxANIC! 프로젝트 코드 기술 분석 및 개선 제안 보고서]
작성일: 2026년 1월 17일
분석 대상: 현재 프로젝트 디렉토리 전체

1. 총평
   이 프로젝트는 Pygame을 기반으로 절차적 텍스처 생성, 행동 트리(Behavior Tree) AI, 상태 머신, 네트워크 동기화 등 고급 기술이 적용된 수준 높은 코드베이스를 가지고 있습니다.
   특히 컴포지션 패턴을 활용한 플레이어 로직 분리와 Master/Slave 구조의 멀티플레이어 설계는 매우 훌륭합니다.
   하지만, 프로젝트 규모가 커짐에 따라 일부 클래스의 책임 비대화(Bloat), 네트워크 보안 취약점, AI의 물리적 한계 무시 등의 문제가 발견되었으며, 이를 개선하면 상용 수준의 완성도를 확보할 수 있습니다.

2. 주요 개선 필요 사항 (Critical Issues)

   A. AI 시야 로직의 버그 (Logic Bug)
      - 파일: entities/npc.py (Dummy 클래스)
      - 문제점: `has_line_of_sight` 함수가 단순히 거리(Distance)만 체크하고 있습니다. 벽이나 장애물을 고려하지 않아 NPC가 벽 너머의 플레이어를 감지하고 추격하는 "투시(Wall-hack)" 현상이 발생합니다.
      - 해결 방안: `systems/fov.py`의 레이캐스팅 로직을 재사용하거나, 두 점 사이의 선분 상에 충돌체(Wall)가 있는지 검사하는 `Bresenham` 알고리즘 기반의 시야 체크 함수를 도입해야 합니다.

   B. 네트워크 보안 및 안정성 (Security & Stability)
      - 파일: server.py, systems/network.py
      - 문제점: 데이터 직렬화에 `pickle` 모듈을 사용하고 있습니다. 이는 신뢰할 수 없는 클라이언트가 조작된 패킷을 보낼 경우 서버에서 임의의 코드가 실행될 수 있는 치명적인 보안 취약점(RCE)이 있습니다.
      - 문제점 2: 예외 처리(`try-except`)가 대부분 `pass`로 처리되어 있어, 네트워크 연결이 끊기거나 패킷 오류가 발생했을 때 원인 파악이 불가능합니다.
      - 해결 방안: 데이터 포맷을 `JSON` 또는 `MessagePack`으로 변경하고, 예외 발생 시 `logger`를 통해 기록하도록 수정해야 합니다.

3. 아키텍처 개선 (Architectural Refactoring)

   A. PlayState 클래스의 비대화 해소 (Decoupling)
      - 파일: states/play_state.py
      - 문제점: `PlayState` 클래스가 너무 많은 책임을 지고 있습니다.
         1. 사운드 시각화 로직 (`_process_sound_effect`)
         2. 날씨 및 페이즈 관리 이벤트 수신
         3. 투표 시스템 및 UI 입력 처리
         4. 카메라 및 렌더링 호출
      - 해결 방안:
         - `SoundSystem`: 사운드 발생, 전파, 시각화 로직을 전담하는 시스템 클래스로 분리.
         - `VoteManager`: 투표 로직 및 결과 처리 분리.
         - `PlayState`는 각 시스템을 조율(Mediator)하는 역할만 수행하도록 경량화.

   B. 전역 설정의 데이터화 (Data-Driven Design)
      - 파일: settings.py, world/tiles.py
      - 현황: 타일 데이터, 아이템 속성 등이 코드 내 딕셔너리로 하드코딩 되어 있거나 `settings.py`에 혼재되어 있습니다.
      - 해결 방안: 모든 게임 밸런스 데이터(아이템 가격, 데미지, 타일 속성 등)를 외부 `JSON` 파일로 완전히 분리하고, `DataManager`를 통해서만 접근하도록 통일하여 기획 수정 용이성을 확보합니다.

4. 성능 최적화 (Performance Optimization)

   A. 맵 렌더링 최적화 (Rendering)
      - 파일: systems/renderer.py (MapRenderer)
      - 문제점: 매 프레임 `draw()` 함수가 화면 내의 모든 타일(수백 개)을 루프 돌며 `blit` 하고 있습니다. 특히 실내/실외 알파값 연산이 매 타일마다 수행됩니다.
      - 해결 방안:
         - `Chunk System`: 맵을 16x16 또는 32x32 크기의 청크로 나누고, 각 청크를 하나의 `Surface`로 미리 그려(Bake) 둡니다.
         - 타일 변경이 일어난 청크만 다시 그립니다.
         - 렌더링 시에는 미리 그려진 청크 이미지만 화면에 복사하므로 드로우콜(Draw Call)이 획기적으로 줄어듭니다.

   B. 사운드 텍스처 풀링 (Object Pooling)
      - 파일: systems/effects.py (VisualSound)
      - 문제점: `VisualSound` 효과가 발생할 때마다 새로운 객체와 Surface를 생성할 가능성이 높습니다.
      - 해결 방안: 자주 사용되는 사운드 효과 객체(발자국 등)는 미리 생성해 둔 풀(Pool)에서 재사용하여 가비지 컬렉션 부하를 줄입니다.

5. 코드 품질 및 유지보수 (Code Quality)

   - 타입 힌트(Type Hinting) 적용: 주요 함수의 매개변수와 반환값에 타입 힌트(`def update(self, dt: float) -> None:`)를 추가하여 가독성을 높이고 IDE의 지원을 받아야 합니다.
   - 매직 넘버 제거: 코드 곳곳에 산재된 숫자 리터럴(예: `if dist < 640:`)을 `settings.py`의 상수로 정의하여 의미를 명확히 해야 합니다.

6. 결론
   현재 코드는 프로토타입을 넘어 알파 버전 단계로 진입하기에 충분한 퀄리티를 가지고 있습니다.
   위에서 언급한 **"AI 시야 버그 수정"**과 **"네트워크 pickle 제거"**를 최우선 순위로 진행하고, 이후 **"PlayState 리팩토링"**을 진행한다면 더욱 견고하고 확장 가능한 프로젝트가 될 것입니다.
